<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard — MLBB</title>
<style>
:root{
  --bg:#091021;
  --card:#0f1726;
  --muted:#89f7ff;
  --neon:#00eaff;
  --accent:#7fffd4;
  --danger:#ff5c7c;
  --success:#6ef08a;
  --glass: rgba(255,255,255,0.04);

}

html,body{
  height:100%;
  margin:0;
  font-family:Inter,ui-sans-serif,system-ui,Arial;
  background:linear-gradient(180deg,#07101a 0%, #0b1622 100%);
  color:#dff8ff

}

.wrap{
  max-width:1200px;
  margin:28px auto;
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:14px

}

header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px

}

h1{
  font-size:28px;
  margin:0;color:var(--neon);
  text-shadow:0 4px 18px rgba(0,230,255,0.06)

}

.controls{
  display:flex;
  gap:10px;
  align-items:center

}

.btn{
  background:linear-gradient(90deg,var(--neon),#00c7d9);
  border:none;
  padding:10px 14px;
  border-radius:10px;
  font-weight:800;
  color:#012;
  cursor:pointer;
  box-shadow:0 10px 30px rgba(0,230,255,0.06)

}

.btn.ghost{
  background:transparent;
  border:1px solid rgba(255,255,255,0.06);color:var(--neon)

}

.card{
  background:linear-gradient(180deg, rgba(0,12,20,0.6), rgba(0,10,15,0.35));
  border-radius:12px;
  padding:12px;
  border:1px solid rgba(0,230,255,0.04);
  box-shadow:0 10px 30px rgba(0,0,0,0.6)

}

.toolbar{
  display:flex;
  gap:8px;
  align-items:center

}

.search{
  padding:8px 10px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.03);
  background:#001620;color:var(--muted)

}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:8px

}

thead th{
  font-size:14px;
  text-align:left;
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,0.04);
  cursor:pointer;
  color:var(--accent)

}

tbody td{
  padding:10px 12px;
  border-bottom:1px dashed rgba(255,255,255,0.02);
  font-weight:700
}

tr:hover td{
  background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02))

}

.status{
  padding:6px 10px;
  border-radius:999px;
  font-weight:800;
  font-size:13px
}
.pending{
  background:rgba(255,200,0,0.08);
  color:#ffd66a;
  border:1px solid rgba(255,200,0,0.06)

}

.completed{
  background:rgba(0,255,140,0.06);
  color:var(--success);
  border:1px solid rgba(0,255,140,0.06)

}

.cancelled{
  background:rgba(255,80,100,0.06);
  color:var(--danger);
  border:1px solid rgba(255,80,100,0.06)

}

.neon-btn{
  background:linear-gradient(90deg,#00f0ff,#00d0b8);
  border:none;
  color:#012;
  padding:8px 10px;
  border-radius:10px;
  font-weight:900;
  cursor:pointer

}

.actions{
  display:flex;
  gap:6px

}


.modal-wrap{
  position:fixed;
  inset:0;
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
  background:rgba(0,0,0,0.6);
  backdrop-filter: blur(3px)

}

.modal{
  width:calc(100% - 40px);
  max-width:760px;
  background:linear-gradient(180deg,#031218,#082029);
  padding:18px;
  border-radius:12px;
  border:1px solid rgba(0,230,255,0.06)

}

.modal h3{
  margin:0 0 10px;
  color:var(--neon)

}

.row{
  display:flex;
  gap:12px;
  flex-wrap:wrap

}

.col{
  flex:1;
  min-width:200px
}

.label{font-size:13px;
  color:#9fe;
  opacity:0.9;
  margin-bottom:6px

}

img.screenshot{
  max-width:260px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.04);
  display:block

}

.toast{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:16%;z-index:11000;
  background:linear-gradient(180deg,#001522,#00161a);
  padding:12px 20px;
  border-radius:12px;
  color:#bffcff;
  font-weight:800;
  border:1px solid rgba(0,230,255,0.06)
}
.small{
  font-size:13px;
  color:#aef

}

.right-controls{
  display:flex;
  gap:8px;
  align-items:center

}
.logout{
  background:#ff7a7a;color:#102;
  border:none;
  padding:8px 10px;
  border-radius:10px;
  font-weight:800;
  cursor:pointer
}
@media(max-width:720px){
  thead th, tbody td{font-size:12px;padding:8px}
  .row{flex-direction:column}
}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div>
    <h1>MLBB Shop — Admin</h1>
    <div class="small">Manage orders • Neon dashboard</div>
  </div>
  <div class="controls">
    <div class="toolbar card">
      <input id="q" class="search" placeholder="Search by game id, tx, package..." />
      <button class="btn ghost" onclick="loadOrders()">Refresh</button>
    </div>
    <div class="right-controls">
      <button class="btn" onclick="location.reload()">Reload</button>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </div>
</header>

<div class="card">
  <table id="ordersTable">
    <thead>
      <tr>
        <th data-key="id">ID ▲▼</th>
        <th data-key="createdAt">Time ▲▼</th>
        <th data-key="packageName">Package ▲▼</th>
        <th data-key="serverId">Server ID</th>
        <th data-key="gameId">Game ID ▲▼</th>
        <th data-key="username">Name</th>
        <th data-key="paymentMethod">Payment</th>
        <th data-key="transactionId">TX</th>
        <th data-key="price">Price</th>
        <th data-key="status">Status ▲▼</th>
        <th>Actions</th>
        <th>Program</th>
      </tr>
    </thead>
    <tbody id="ordersBody">
      <tr><td colspan="10" style="text-align:center;padding:40px">Loading...</td></tr>
    </tbody>
  </table>
</div>
</div>

<!-- modal -->
<div id="modal" class="modal-wrap">
  <div class="modal">
    <h3>Order Details / Exchange</h3>
    <div id="modalContent" class="row"></div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn ghost" onclick="closeModal()">Close</button>
      <button id="cancelBtn" class="neon-btn" style="background:linear-gradient(90deg,#ff8080,#ff5c7c)" onclick="">Cancel Order</button>
      <button id="completeBtn" class="neon-btn" onclick="">Mark Completed</button>
    </div>
  </div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
const API = (location.protocol === 'file:' ? 'https://api.render.com/deploy/srv-d4q1grndiees7391ijqg?key=9HvqZulcg9E' : location.origin);
const token = localStorage.getItem('adminToken');
if(!token){
  alert('Not authenticated - please login');
  window.location.href = 'admin-login.html';
}

let orders = [];
let sortKey = 'id';
let sortDir = -1;

function showToast(msg, t=2500){
  const el = document.getElementById('toast');
  el.innerText = msg;
  el.style.display = 'block';
  setTimeout(()=> el.style.display='none', t);
}

async function loadOrders(){
  document.getElementById('ordersBody').innerHTML = '<tr><td colspan="10" style="text-align:center;padding:30px">Loading...</td></tr>';
  try{
    const res = await fetch(API + '/admin/orders', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if(!res.ok){ throw new Error('Auth failed'); }
    orders = await res.json();
    renderTable(orders);
  } catch (err){
    console.error(err);
    showToast('Load failed. Login again.');
    localStorage.removeItem('adminToken');
    setTimeout(()=> location.href='admin-login.html', 800);
  }
}

function renderTable(list){
  const q = (document.getElementById('q').value || '').toLowerCase().trim();
  let filtered = list.filter(o=>{
    if(!q) return true;
    return (String(o.gameId)+String(o.transactionId)+String(o.packageName)).toLowerCase().includes(q);
  });

  filtered.sort((a,b)=>{
    let A = a[sortKey], B = b[sortKey];
    if(sortKey==='createdAt'){ A=new Date(A).getTime(); B=new Date(B).getTime(); }
    if(typeof A==='string') A=A.toLowerCase();
    if(typeof B==='string') B=B.toLowerCase();
    if(A<B) return -1*sortDir;
    if(A>B) return 1*sortDir;
    return 0;
  });

  const body = document.getElementById('ordersBody');
  if(!filtered.length){ body.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:30px">No orders found</td></tr>'; return; }

  body.innerHTML = filtered.map(o=>{
    const statusClass = o.status==='pending'?'pending':(o.status==='completed'?'completed':'cancelled');
    return `<tr>
      <td>${o.id}</td>
      <td>${new Date(o.createdAt).toLocaleString()}</td>
      <td>${escapeHtml(o.packageName)}</td>
      <td>${escapeHtml(o.serverId)}</td>
      <td>${escapeHtml(o.gameId)}</td>
      <td>${escapeHtml(o.username)}</td>
      <td>${escapeHtml(o.paymentMethod||'')}</td>
      <td>${escapeHtml(o.transactionId)}</td>
      <td>${Number(o.price).toLocaleString()} Ks</td>
      <td><span class="status ${statusClass}">${escapeHtml(o.status)}</span></td>
      <td class="actions">
        <button class="btn ghost" onclick="openDetails(${o.id})">View</button>
      </td>
      <td class="walled">
        <button class="btn neon-btn" onclick="openExchange(${o.id})">Exchange</button>
      </td>
    </tr>`;
  }).join('');
}

document.querySelectorAll('thead th[data-key]').forEach(th=>{
  th.addEventListener('click', ()=>{
    const key = th.dataset.key;
    if(sortKey===key) sortDir*=-1; else { sortKey=key; sortDir=-1; }
    renderTable(orders);
  });
});

function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function openDetails(id){
  const o = orders.find(x=>String(x.id)===String(id));
  if(!o) return showToast('Order not found');
  const container = document.getElementById('modalContent');
  container.innerHTML = `
    <div class="col">
      <div class="label">Package</div><div>${escapeHtml(o.packageName)}</div>
      <div class="label">Price</div><div>${Number(o.price).toLocaleString()} Ks</div>
      <div class="label">Note</div><div>${escapeHtml(o.orderNote||'')}</div>
    </div>
    <div class="col">
      <div class="label">Game ID</div><div>${escapeHtml(o.gameId)}</div>
      <div class="label">Uer Name<div><div>${escapeHtml(o.username)}</div>
      <div class="label">Server</div><div>${escapeHtml(o.serverId)}</div>
      <div class="label">Payment</div><div>${escapeHtml(o.paymentMethod||'')} • TX: ${escapeHtml(o.transactionId||'')}</div>
    </div>
    <div class="col">
      <div class="label">Status</div><div><span class="status ${o.status==='pending'?'pending':(o.status==='completed'?'completed':'cancelled')}">${o.status}</span></div>
      ${o.paymentScreenshot?`<div class="label">Payment Screenshot</div><img class="screenshot" src="${escapeHtml(o.paymentScreenshot)}" alt="screenshot" onerror="this.style.display='none'">`:''}
    </div>
  `;
  document.getElementById('completeBtn').onclick = ()=>updateStatus(o.id,'completed');
  document.getElementById('cancelBtn').onclick = ()=>updateStatus(o.id,'cancelled');
  document.getElementById('completeBtn').style.display='inline-block';
  document.getElementById('cancelBtn').style.display='inline-block';
  document.getElementById('modal').style.display='flex';
}

function openExchange(orderId){
  const o = orders.find(x => String(x.id) === String(orderId));
  if(!o) return showToast('Order not found');
  const container = document.getElementById('modalContent');
  container.innerHTML = `
    <div class="col">
      <button class="btn neon-btn" onclick="window.open('https://www.smile.one/','_blank')">Open Smile One Web</button>
    </div>
    <div class="col">
      <button class="btn neon-btn" onclick="window.open('https://t.me/ryzenseller','_blank')">Open Telegram</button>
    </div>
  `;
  document.getElementById('completeBtn').style.display='none';
  document.getElementById('cancelBtn').style.display='none';
  document.getElementById('modal').style.display='flex';
}

function closeModal(){
  document.getElementById('modal').style.display='none';
  document.getElementById('completeBtn').style.display='inline-block';
  document.getElementById('cancelBtn').style.display='inline-block';
}

async function updateStatus(id,newStatus){
  if(!confirm('Change status to "'+newStatus+'"?')) return;
  showToast('Updating...');
  try{
    const res = await fetch(API+'/admin/orders/'+id+'/status',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
      body: JSON.stringify({status:newStatus})
    });
    if(!res.ok){ const err = await res.json().catch(()=>({error:'Update failed'})); throw new Error(err.error||'Update failed'); }
    const data = await res.json();
    showToast('Updated: '+data.order.status);
    await loadOrders();
    closeModal();
  } catch(err){ console.error(err); showToast(err.message||'Update failed',3000); }
}

function logout(){ localStorage.removeItem('adminToken'); location.href='admin-login.html'; }
document.getElementById('q').addEventListener('input',()=>renderTable(orders));
loadOrders();


</script>
</body>
</html>
